import{r as l,u as te,j as e}from"./index-D7BPkl7L.js";import{a as f}from"./index-xsH4HHeE.js";import{L as C,A as re}from"./Layout-CvxaU38W.js";import{m as I,w as ne,x as ie,u as le,v as oe,r as de,s as ce,j as me,a as xe,l as ue,E as T,p as he,n as D,o as pe}from"./proxy-CFRt1oNv.js";function we(){const[k,M]=l.useState([]),[G,h]=l.useState(!1),[p,c]=l.useState(null),[j,P]=l.useState(null),[B,g]=l.useState(!1),[m,_]=l.useState(null),[A,S]=l.useState(null),[b,O]=l.useState(""),[z,J]=l.useState([]),[H,K]=l.useState([]),y=te(),[R,w]=l.useState(!1),[E,U]=l.useState({scheduleId:null,assistantId:null,assistantName:""}),[q,X]=l.useState({}),[u,N]=l.useState({jadwal_id:"",asisten_id:""});l.useEffect(()=>{const s=localStorage.getItem("token");if(s)try{const t=JSON.parse(atob(s.split(".")[1]));P({id:t.user_id,...t})}catch(t){console.error("Token parsing error:",t),y("/login")}else y("/login")},[y]);const v=async()=>{var s,t,a;try{h(!0),c(null);const r=await f.get("http://localhost:8080/api/admin/asisten-kelas",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"}});M(r.data)}catch(r){console.error("Fetch error:",r),c(((t=(s=r.response)==null?void 0:s.data)==null?void 0:t.error)||r.message||"Failed to load schedules"),((a=r.response)==null?void 0:a.status)===403&&(c("Anda tidak memiliki akses ke halaman ini"),y("/"))}finally{h(!1)}},Q=async()=>{try{const t=(await f.get("http://localhost:8080/api/admin/users",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"}})).data.filter(a=>a.role==="asisten"&&a.status==="aktif");J(t)}catch(s){console.error("Error fetching assistants:",s)}},V=async()=>{try{const s=await f.get("http://localhost:8080/api/admin/jadwal",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"}});K(s.data)}catch(s){console.error("Error fetching schedules:",s)}};l.useEffect(()=>{j!=null&&j.id&&(v(),Q(),V())},[j==null?void 0:j.id]);const W=()=>{const s={},t={};return k.forEach(a=>{t[a.jadwal_id]?t[a.jadwal_id].assistants.push(a.user):t[a.jadwal_id]={...a.jadwal,assistants:[a.user]}}),Object.values(t).forEach(a=>{var d;const r=((d=a.mata_kuliah.program_studi)==null?void 0:d.nama)||"Lainnya",n=`Semester ${a.semester}`;s[r]||(s[r]={}),s[r][n]||(s[r][n]=[]),s[r][n].push(a)}),s},$=(()=>{const s=W();if(!b)return s;const t={};return Object.entries(s).forEach(([a,r])=>{t[a]={},Object.entries(r).forEach(([n,d])=>{const i=d.filter(o=>{const x=b.toLowerCase();return o.mata_kuliah.nama.toLowerCase().includes(x)||o.mata_kuliah.kode.toLowerCase().includes(x)||o.dosen.nama.toLowerCase().includes(x)||o.assistants.some(L=>L.nama.toLowerCase().includes(x)||L.nim.toLowerCase().includes(x))||o.kelas.toLowerCase().includes(x)||o.lab.toLowerCase().includes(x)});i.length>0&&(t[a][n]=i)}),Object.keys(t[a]).length===0&&delete t[a]}),t})(),Y=(s,t)=>{const a=`${s}-${t}`;X(r=>({...r,[a]:!r[a]}))},F=s=>{const{name:t,value:a}=s.target;N({...u,[t]:a})},Z=s=>{var t;try{if(!s)throw new Error("Schedule object is undefined");const a=s.jadwal_id||((t=s.jadwal)==null?void 0:t.id)||s.id;if(!a)throw new Error("Jadwal ID not found in schedule object");_(s),N({jadwal_id:a.toString(),asisten_id:""}),g(!0)}catch(a){console.error("Error opening edit modal:",a),c("Gagal memuat data jadwal: "+a.message)}},ee=async s=>{var t,a,r;if(s.preventDefault(),!u.jadwal_id||!u.asisten_id){c("Harap pilih jadwal dan asisten");return}try{h(!0),c(null);const n={jadwal_id:Number(u.jadwal_id),asisten_id:Number(u.asisten_id)};console.log("Submitting payload:",n),await f.post("http://localhost:8080/api/admin/asisten-kelas",n,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"}}),S("Asisten berhasil ditambahkan ke jadwal"),N({jadwal_id:"",asisten_id:""}),v(),g(!1)}catch(n){console.error("Error saving schedule:",n),console.error("Error response data:",(t=n.response)==null?void 0:t.data),c(((r=(a=n.response)==null?void 0:a.data)==null?void 0:r.error)||"Gagal menyimpan jadwal asisten")}finally{h(!1)}},se=(s,t,a)=>{U({scheduleId:s,assistantId:t,assistantName:a}),w(!0)},ae=async()=>{var s,t,a,r;try{h(!0),c(null);const{scheduleId:n,assistantId:d}=E;console.log("Mengirim request delete dengan:",{scheduleId:n,assistantId:d});const i=await f.delete(`http://localhost:8080/api/admin/asisten-kelas/${n}/${d}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"}});console.log("Response dari server:",i.data),i.data&&i.data.message?(S(i.data.message),v()):(S("Asisten berhasil dihapus dari jadwal"),v())}catch(n){console.error("Error saat menghapus asisten:",n),c(((t=(s=n.response)==null?void 0:s.data)==null?void 0:t.error)||((r=(a=n.response)==null?void 0:a.data)==null?void 0:r.message)||n.message||"Gagal menghapus asisten dari jadwal")}finally{h(!1),w(!1)}};return G&&k.length===0?e.jsx(C,{children:e.jsx("main",{className:"flex-1 p-6 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-blue-500 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Memuat data jadwal..."})]})})}):p&&k.length===0?e.jsx(C,{children:e.jsx("main",{className:"flex-1 p-6 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-red-500",children:[e.jsxs("p",{children:["Gagal memuat data: ",p]}),e.jsx("button",{onClick:()=>window.location.reload(),className:"mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Coba Lagi"})]})})}):e.jsx(C,{children:e.jsxs("main",{className:"flex-1 p-6",children:[e.jsxs("div",{className:"mb-6 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Data Plotingan"}),e.jsx("p",{className:"text-gray-600",children:"Kelola jadwal asisten kelas/laboratorium"}),e.jsxs(re,{children:[p&&e.jsx(I.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},exit:{opacity:0},className:"mb-4 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded",children:e.jsx("p",{children:p})}),A&&e.jsx(I.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},exit:{opacity:0},className:"mb-4 p-4 bg-green-100 border-l-4 border-green-500 text-green-700 rounded",children:e.jsx("p",{children:A})})]})]}),e.jsxs("button",{onClick:()=>{_(null),N({jadwal_id:"",asisten_id:""}),g(!0)},className:"flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(ne,{className:"mr-2"})," Ploting Asisten"]})]}),e.jsx("div",{className:"mb-6 relative",children:e.jsxs("div",{className:"relative max-w-md",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(ie,{className:"text-gray-400"})}),e.jsx("input",{type:"text",placeholder:"Cari berdasarkan mata kuliah, dosen, asisten...",className:"text-black block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",value:b,onChange:s=>O(s.target.value)})]})}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm overflow-hidden space-y-6 overflow-y-auto",style:{maxHeight:"495px"},children:Object.keys($).length===0?e.jsx("div",{className:"p-6 text-center text-gray-500",children:b?"Tidak ditemukan jadwal yang sesuai dengan pencarian":"Tidak ada data jadwal"}):Object.entries($).map(([s,t])=>e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-white text-xl font-semibold bg-gradient-to-r from-blue-600 to-indigo-700 p-4",children:s}),Object.entries(t).map(([a,r])=>{const n=`${s}-${a}`,d=q[n]!==!1;return e.jsxs("div",{children:[e.jsxs("div",{className:"text-black flex justify-between items-center p-4 bg-gray-200 cursor-pointer hover:bg-gray-400",onClick:()=>Y(s,a),children:[e.jsx("h3",{className:"text-lg font-medium",children:a}),d?e.jsx(le,{}):e.jsx(oe,{})]}),d&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Mata Kuliah"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Hari/Jam"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Kelas/Lab"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Dosen"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Asisten"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Aksi"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:r.map(i=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0 h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx(de,{className:"text-blue-600"})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:i.mata_kuliah.nama}),e.jsx("div",{className:"text-sm text-gray-500",children:i.mata_kuliah.kode})]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ce,{className:"text-gray-400 mr-2"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:i.hari}),e.jsxs("div",{className:"text-sm text-gray-500 flex items-center",children:[e.jsx(me,{className:"mr-1"}),i.jam_mulai," - ",i.jam_selesai]})]})]})}),e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("div",{className:"text-sm text-gray-900",children:i.kelas}),e.jsx("div",{className:"text-sm text-gray-500",children:i.lab})]}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(xe,{className:"text-gray-400 mr-2"}),e.jsx("div",{className:"text-sm text-gray-900",children:i.dosen.nama})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"space-y-2",children:i.assistants.map((o,x)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(ue,{className:"text-gray-400 mr-2"}),e.jsxs("div",{className:"text-sm text-gray-900",children:[o.nama," (",o.nim,")"]})]}),e.jsx("button",{onClick:()=>se(i.id,o.id,o.nama),className:"text-red-600 hover:text-red-900 p-2 rounded-full hover:bg-red-50 transition-colors",children:e.jsx(T,{})})]},x))})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsxs("button",{onClick:()=>Z(i),className:"text-blue-600 hover:text-blue-900",children:[e.jsx(he,{className:"inline mr-1"})," Tambah Asisten"]})})]},i.id))})]})})]},n)})]},s))}),R&&e.jsx("div",{className:"fixed inset-0 drop-shadow-2xl bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md",children:[e.jsxs("div",{className:"flex justify-between items-center px-6 py-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Konfirmasi Penghapusan"}),e.jsx("button",{onClick:()=>w(!1),className:"text-gray-400 hover:text-gray-500",children:e.jsx(D,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"p-6",children:[e.jsxs("p",{className:"text-gray-700 mb-4",children:["Apakah Anda yakin ingin menghapus asisten ",e.jsx("span",{className:"font-semibold",children:E.assistantName})," dari jadwal ini?"]}),e.jsxs("div",{className:"flex justify-end pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>w(!1),className:"mr-3 px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50",children:"Batal"}),e.jsxs("button",{type:"button",onClick:ae,className:"px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:[e.jsx(T,{className:"inline mr-1"})," Hapus"]})]})]})]})}),B&&e.jsx("div",{className:"fixed inset-0 drop-shadow-2xl bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md",children:[e.jsxs("div",{className:"flex justify-between items-center  px-6 py-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:m?"Tambah Asisten ke Jadwal":"Ploting Jadwal Asisten"}),e.jsx("button",{onClick:()=>g(!1),className:"text-gray-400 hover:text-gray-500",children:e.jsx(D,{className:"h-6 w-6"})})]}),e.jsxs("form",{onSubmit:ee,className:"p-6",children:[p&&e.jsx("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded",children:p}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Jadwal"}),e.jsxs("select",{name:"jadwal_id",value:u.jadwal_id,onChange:F,className:"text-black w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",required:!0,disabled:!!m,children:[m?e.jsxs("option",{value:m.jadwal_id,children:[m.mata_kuliah.nama," - ",m.hari," ",m.jam_mulai,"-",m.jam_selesai]}):e.jsx("option",{value:"",children:"Pilih Jadwal"}),!m&&H.map(s=>e.jsxs("option",{value:s.id,children:[s.mata_kuliah.nama," - ",s.hari," ",s.jam_mulai,"-",s.jam_selesai]},s.id))]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Asisten"}),e.jsxs("select",{name:"asisten_id",value:u.asisten_id,onChange:F,className:"text-black w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"Pilih Asisten"}),z.map(s=>e.jsxs("option",{value:s.id,children:[s.nama," (",s.nim,")"]},s.id))]})]}),e.jsxs("div",{className:"flex justify-end pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>g(!1),className:"mr-3 px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50",children:"Batal"}),e.jsxs("button",{type:"submit",className:"px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(pe,{className:"inline mr-1"})," Simpan"]})]})]})]})})]})})}export{we as default};
